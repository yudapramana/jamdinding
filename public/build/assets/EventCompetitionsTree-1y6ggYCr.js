import{z as ne,y as C,A as g,O as D,V as ie,B as c,C as p,D as t,I as h,J as r,K as f,S,as as G,aB as A,U as M,ay as R,a as k,ah as F,L as oe,aC as le}from"./AuthUserStore-B6VIMEgo.js";import{S as v}from"./sweetalert2.esm.all-9Qm2jZ7z.js";import{_ as re,$ as _}from"./app-DdJgNepn.js";import"./style-BzZfqcl-.js";const de={class:"content-header"},ue={class:"container-fluid"},me={class:"d-flex justify-content-between align-items-center"},ce={key:0,class:"mb-0 mt-1 text-sm text-muted"},pe={key:0},ve={class:"btn-group"},fe=["disabled"],ge=["disabled"],_e=["disabled"],be={key:0,class:"text-danger text-sm mt-2 mb-0"},ye={class:"content"},he={class:"container-fluid"},ke={class:"card"},we={class:"card-header"},xe={class:"d-flex flex-wrap justify-content-between align-items-center w-100"},Se={class:"d-flex flex-wrap align-items-center"},$e={class:"modal fade",id:"competitionModal",tabindex:"-1",role:"dialog","aria-hidden":"true"},Te={class:"modal-dialog modal-lg",role:"document"},Ee={class:"modal-content"},je={class:"modal-header"},Be={class:"modal-title"},Ce={class:"modal-body"},De={key:0,class:"alert alert-info text-sm mb-3"},Ge={class:"form-row"},Me={class:"form-group col-md-6"},Ve=["value"],Ie={class:"form-group col-md-6"},Ke=["value"],Ue={key:0,class:"text-muted d-block mt-1"},Ne={class:"form-group col-md-12"},Pe={class:"form-group col-md-6"},Ae={class:"modal-footer"},Re=["disabled"],Fe={key:0,class:"fas fa-spinner fa-spin mr-1"},He={__name:"EventCompetitionsTree",setup(Je){const H=oe(),J=ne(),b=C(()=>J.eventData||null),l=C(()=>{var a;return((a=b.value)==null?void 0:a.id)||null}),V=g([]),w=g([]),j=g([]),$=g(""),T=g(!1),E=g(!1),n=g(I());function I(){return{id:null,event_group_id:"",round_id:"",full_name:"",scheduled_at:""}}const y=a=>String(a??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),L=a=>{const e=String(a||"");return e==="draft"?"badge-secondary":e==="ongoing"?"badge-info":e==="finished"?"badge-success":e==="cancelled"?"badge-danger":"badge-light"},O=a=>{if(!a)return"-";const e=new Date(a);if(Number.isNaN(e.getTime()))return a;const s=String(e.getDate()).padStart(2,"0"),o=String(e.getMonth()+1).padStart(2,"0"),m=e.getFullYear(),d=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0");return`${s}-${o}-${m} ${d}:${i}`},B=C(()=>{const a=String(n.value.event_group_id||"");return(w.value||[]).find(e=>String(e.id)===a)||null});D(()=>n.value.event_group_id,a=>{const e=(w.value||[]).find(s=>String(s.id)===String(a));n.value.full_name=(e==null?void 0:e.full_name)||""});const K=async()=>{if(!l.value)return;const{data:a}=await k.get(`/api/v1/events/${l.value}/competitions/meta`);V.value=a.rounds||[],w.value=a.event_groups||[]},U=async()=>{if(!l.value)return;const{data:a}=await k.get(`/api/v1/events/${l.value}/competitions/tree`,{params:{search:$.value||""}});j.value=a.rounds||[]},N=async()=>{await F();const a=_("#tree-container");a.jstree(!0)&&a.jstree(!0).destroy(),a.off(".jstree"),a.off("activate_node.jstree"),a.off("select_node.jstree"),a.off("click",".js-edit-competition"),a.off("click",".js-del-competition"),a.jstree({core:{check_callback:!0,themes:{stripes:!0},html_titles:!0,data:(e,s)=>{var o;if(e.id==="#"){const m=(j.value||[]).map(d=>{var i;return{id:`round-${d.id}`,type:"round",children:!0,data:{roundId:d.id},text:`
              <span class="tree-round">
                <strong>${y(d.name)}</strong>
                <span class="badge badge-light border ml-2">${((i=d.competitions)==null?void 0:i.length)||0} kompetisi</span>
              </span>
            `}});s(m);return}if(e.type==="round"){const m=String(((o=e.data)==null?void 0:o.roundId)||""),d=(j.value||[]).find(u=>String(u.id)===String(m)),i=(d==null?void 0:d.competitions)||[];if(!i.length){s([{id:`info-empty-${m}`,type:"info",children:!1,text:'<span class="text-muted">Belum ada kompetisi di babak ini.</span>'}]);return}s(i.map(u=>{var P;const Z=u.is_team?'<span class="badge badge-dark ml-2">TEAM</span>':"",ee=L(u.status),te=y(O(u.scheduled_at)),ae=y(u.venue||"-"),se=y(((P=u.event_group)==null?void 0:P.full_name)||"-");return{id:`comp-${u.id}`,type:"competition",children:!1,data:{competitionId:u.id},text:`
                <span class="tree-comp">
                  <span class="tree-comp-title">
                    <strong>${y(u.full_name)}</strong>
                    ${Z}
                    <span class="badge ${ee} ml-2">${y(u.status)}</span>
                  </span>

                  <span class="tree-comp-sub text-muted">
                    <span class="mr-2"><i class="far fa-clock mr-1"></i>${te}</span>
                    <span class="mr-2"><i class="fas fa-map-marker-alt mr-1"></i>${ae}</span>
                    <span class="mr-2"><i class="fas fa-layer-group mr-1"></i>${se}</span>
                  </span>

                  <span class="tree-actions ml-2">
                    <a href="#" class="badge badge-info js-edit-competition" data-id="${u.id}">
                      <i class="fas fa-edit mr-1"></i>Edit
                    </a>
                    <a href="#" class="badge badge-danger js-del-competition ml-1" data-id="${u.id}">
                      <i class="fas fa-trash mr-1"></i>Hapus
                    </a>
                  </span>
                </span>
              `}}));return}s([])}},plugins:["types","state","search"],state:{key:"event-competitions-tree-v2",filter:e=>{var s;return(s=e==null?void 0:e.core)!=null&&s.selected&&(e.core.selected=[]),e}},types:{round:{icon:"far fa-folder"},competition:{icon:"far fa-flag"},info:{icon:"far fa-circle"}}}),a.on("activate_node.jstree",(e,s)=>{if(!s||!s.node)return;const o=s.node;if(o.type==="round"){_("#tree-container").jstree(!0).toggle_node(o);return}if(o.type==="competition"){const m=String(o.id).replace("comp-","");H.push({name:"admin.event.scoring.input-specific",params:{id:m}})}}),a.on("click",".js-edit-competition",async e=>{e.preventDefault(),e.stopPropagation();const s=e.currentTarget.getAttribute("data-id");return s&&await Q(s),!1}),a.on("click",".js-del-competition",async e=>{e.preventDefault(),e.stopPropagation();const s=e.currentTarget.getAttribute("data-id");return s&&await X(s),!1})},x=async()=>{await U(),await N()},Y=async()=>{await F();const a=_("#tree-container").jstree(!0);if(a){try{a.clear_state()}catch{}try{a.deselect_all(!0),a.close_all("#",0),a.redraw(!0)}catch{}}},q=le(a=>{const e=_("#tree-container").jstree(!0);e&&e.search(a)},300);D(()=>$.value,a=>{x(),q(a)});const z=async()=>{if(!l.value){v.fire("Event belum dipilih","Silakan pilih event melalui Portal Event terlebih dahulu.","info");return}T.value=!1,n.value=I(),_("#competitionModal").modal("show")},Q=async a=>{try{const{data:e}=await k.get(`/api/v1/event-competitions/${a}`);T.value=!0,n.value={id:e.id,event_group_id:e.event_group_id,round_id:e.round_id,full_name:"",scheduled_at:e.scheduled_at?String(e.scheduled_at).slice(0,16):""};const s=(w.value||[]).find(o=>String(o.id)===String(n.value.event_group_id));n.value.full_name=(s==null?void 0:s.full_name)||e.full_name||"",_("#competitionModal").modal("show")}catch(e){console.error(e),v.fire("Gagal","Gagal memuat data kompetisi.","error")}},W=async()=>{var e,s;if(!l.value)return;const a=B.value;if(n.value.full_name=(a==null?void 0:a.full_name)||n.value.full_name||"",!n.value.round_id||!n.value.event_group_id){v.fire("Validasi","Round dan Event Group wajib diisi.","warning");return}E.value=!0;try{const o={event_id:l.value,round_id:n.value.round_id,event_group_id:n.value.event_group_id,full_name:n.value.full_name,scheduled_at:n.value.scheduled_at?n.value.scheduled_at.replace("T"," "):null};T.value&&n.value.id?(await k.put(`/api/v1/event-competitions/${n.value.id}`,o),v.fire("Berhasil","Kompetisi berhasil diperbarui.","success")):(await k.post(`/api/v1/events/${l.value}/competitions`,o),v.fire("Berhasil","Kompetisi berhasil ditambahkan.","success")),_("#competitionModal").modal("hide"),await x()}catch(o){console.error(o),v.fire("Gagal",((s=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:s.message)||"Terjadi kesalahan saat menyimpan.","error")}finally{E.value=!1}},X=async a=>{if((await v.fire({title:"Hapus kompetisi?",text:"Data yang dihapus tidak dapat dikembalikan.",icon:"warning",showCancelButton:!0,confirmButtonText:"Ya, hapus",cancelButtonText:"Batal",confirmButtonColor:"#d33"})).isConfirmed)try{await k.delete(`/api/v1/event-competitions/${a}`),v.fire("Terhapus","Kompetisi berhasil dihapus.","success"),await x()}catch(s){console.error(s),v.fire("Gagal","Gagal menghapus kompetisi.","error")}};return ie(async()=>{if(!l.value){v.fire("Event belum dipilih","Silakan pilih event melalui Portal Event terlebih dahulu.","info");return}try{await K(),await U(),await N()}catch(a){console.error(a),v.fire("Gagal","Gagal memuat data kompetisi.","error")}}),D(()=>l.value,async a=>{a&&(await K(),await x())}),(a,e)=>{var s,o,m,d;return p(),c(M,null,[t("section",de,[t("div",ue,[t("div",me,[t("div",null,[e[7]||(e[7]=t("h1",{class:"mb-1"},"Kompetisi Event",-1)),e[8]||(e[8]=t("p",{class:"mb-0 text-muted text-sm"}," Mengelola daftar kompetisi per babak (Round) dalam event aktif. ",-1)),l.value?(p(),c("p",ce,[e[5]||(e[5]=r(" Event aktif: ")),t("strong",null,f((s=b.value)==null?void 0:s.event_name),1),(o=b.value)!=null&&o.event_year?(p(),c("span",pe," ("+f(b.value.event_year)+")",1)):h("",!0),e[6]||(e[6]=r(" • Lokasi: ")),t("strong",null,f(((m=b.value)==null?void 0:m.event_location)||"-"),1)])):h("",!0)]),t("div",ve,[t("button",{class:"btn btn-sm btn-primary",disabled:!l.value,onClick:z},e[9]||(e[9]=[t("i",{class:"fas fa-plus mr-1"},null,-1),r(" Tambah Kompetisi ")]),8,fe),t("button",{class:"btn btn-sm btn-outline-secondary",disabled:!l.value,onClick:x},e[10]||(e[10]=[t("i",{class:"fas fa-sync mr-1"},null,-1),r(" Refresh ")]),8,ge),t("button",{class:"btn btn-sm btn-outline-secondary",disabled:!l.value,onClick:Y}," Reset View ",8,_e)])]),l.value?h("",!0):(p(),c("p",be,e[11]||(e[11]=[t("i",{class:"fas fa-exclamation-triangle mr-1"},null,-1),r(" Event belum dipilih. Silakan pilih event melalui Portal Event terlebih dahulu. ")])))])]),t("section",ye,[t("div",he,[t("div",ke,[t("div",we,[t("div",xe,[t("div",Se,[e[12]||(e[12]=t("label",{class:"mb-0 mr-2 text-sm text-muted"},"Cari",-1)),S(t("input",{"onUpdate:modelValue":e[0]||(e[0]=i=>$.value=i),type:"text",class:"form-control form-control-sm w-auto",style:{"min-width":"260px"},placeholder:"Cari nama kompetisi / venue..."},null,512),[[G,$.value]])]),e[13]||(e[13]=t("div",{class:"text-muted text-sm mt-2 mt-sm-0"},[r(" Tampilan tree dikelompokkan per "),t("strong",null,"Babak")],-1))])]),e[14]||(e[14]=t("div",{class:"card-body"},[t("div",{id:"tree-container"})],-1))])]),t("div",$e,[t("div",Te,[t("div",Ee,[t("div",je,[t("h5",Be,f(T.value?"Edit Kompetisi":"Tambah Kompetisi"),1),e[15]||(e[15]=t("button",{type:"button",class:"close","data-dismiss":"modal","aria-label":"Close"},[t("span",{"aria-hidden":"true"},"×")],-1))]),t("div",Ce,[l.value?(p(),c("div",De,[e[16]||(e[16]=r(" Event: ")),t("strong",null,f((d=b.value)==null?void 0:d.event_name),1)])):h("",!0),t("div",Ge,[t("div",Me,[e[18]||(e[18]=t("label",{class:"mb-1"},[r("Babak (Round) "),t("span",{class:"text-danger"},"*")],-1)),S(t("select",{"onUpdate:modelValue":e[1]||(e[1]=i=>n.value.round_id=i),class:"form-control form-control-sm"},[e[17]||(e[17]=t("option",{value:"",disabled:""},"-- Pilih Babak --",-1)),(p(!0),c(M,null,R(V.value,i=>(p(),c("option",{key:i.id,value:i.id},f(i.name),9,Ve))),128))],512),[[A,n.value.round_id]])]),t("div",Ie,[e[22]||(e[22]=t("label",{class:"mb-1"},[r("Golongan Event (Event Group) "),t("span",{class:"text-danger"},"*")],-1)),S(t("select",{"onUpdate:modelValue":e[2]||(e[2]=i=>n.value.event_group_id=i),class:"form-control form-control-sm"},[e[19]||(e[19]=t("option",{value:"",disabled:""},"-- Pilih Golongan --",-1)),(p(!0),c(M,null,R(w.value,i=>(p(),c("option",{key:i.id,value:i.id},f(i.full_name||i.name),9,Ke))),128))],512),[[A,n.value.event_group_id]]),B.value?(p(),c("small",Ue,[e[20]||(e[20]=r(" Tipe: ")),t("strong",null,f(B.value.is_team?"TEAM":"INDIVIDU"),1),e[21]||(e[21]=r(" (diambil dari Event Group) "))])):h("",!0)]),t("div",Ne,[e[23]||(e[23]=t("label",{class:"mb-1"},[r("Nama Kompetisi (otomatis) "),t("span",{class:"text-danger"},"*")],-1)),S(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>n.value.full_name=i),type:"text",class:"form-control form-control-sm",readonly:""},null,512),[[G,n.value.full_name]]),e[24]||(e[24]=t("small",{class:"text-muted"},[r(" Otomatis mengikuti "),t("strong",null,"Event Group"),r(". ")],-1))]),t("div",Pe,[e[25]||(e[25]=t("label",{class:"mb-1"},"Jadwal (scheduled_at)",-1)),S(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>n.value.scheduled_at=i),type:"datetime-local",class:"form-control form-control-sm"},null,512),[[G,n.value.scheduled_at]])])]),e[26]||(e[26]=t("small",{class:"text-muted"}," * Kombinasi unik: event + group + round (akan ditolak jika duplikat). ",-1))]),t("div",Ae,[e[28]||(e[28]=t("button",{class:"btn btn-sm btn-secondary","data-dismiss":"modal"},"Batal",-1)),t("button",{class:"btn btn-sm btn-primary",disabled:E.value,onClick:W},[E.value?(p(),c("i",Fe)):h("",!0),e[27]||(e[27]=r(" Simpan "))],8,Re)])])])])])],64)}}},ze=re(He,[["__scopeId","data-v-e75f82ac"]]);export{ze as default};
